<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Daily Codex - Medieval Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Crimson+Text:wght@400;600;700&family=Cardo:wght@400;700&family=Cormorant+Garamond:wght@400;600&family=IM+Fell+English+SC&family=Special+Elite&display=swap" rel="stylesheet">
    <script type="module" src="assets/js/emoji-picker-element/index.js"></script>
    <style>
        /* ================================== */
        /* STYLES (CSS)                       */
        /* ================================== */

        :root {
            /* Medieval Color Palette */
            --color-parchment: #fef7e6; /* Manuscript background */
            --color-ink: #3d342d;       /* Main text color */
            --color-dark-ink: #1f1a16;
            --color-wood: #a0522d;      /* Brown for structure */
            --color-copper: #b87333;    /* For buttons or details */
            --color-border: #704214;    /* Darker border */
        }

        body {
            background-color: #e0d0b0; /* A subtle "plank" background or atmosphere */
            font-family: 'Cormorant Garamond', serif; /* Readable base font with a classic feel */
            color: var(--color-ink);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            user-select: none; /* Prevent text selection by default */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .journal-container {
            width: 90%;
            max-width: 800px;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.5); /* Shadow for depth */
            border: 10px solid var(--color-wood); /* "Wood" frame */
            background: linear-gradient(to bottom, #f3e9d7 0%, var(--color-parchment) 100%); /* Aging effect */
            padding: 30px;
            border-radius: 5px;
        }

        /* --- Titles and Header --- */

        .title-script {
            font-family: 'Cinzel Decorative', serif; /* More stylized font for the main title */
            font-size: 2.5em;
            color: var(--color-dark-ink);
            text-align: center;
            margin-bottom: 5px;
            text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.7);
        }

        .journal-header {
            border-bottom: 2px solid var(--color-copper); /* Copper separator */
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .date-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .date-script {
            font-family: 'IM Fell English SC', serif;
            font-size: 1.5em;
            color: var(--color-border);
            margin: 0 10px;
            text-align: center;
            flex-grow: 1; /* Allows space to expand */
        }

        .nav-button {
            background-color: var(--color-copper);
            color: white;
            border: 2px solid var(--color-border);
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.9em;
            border-radius: 3px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s, transform 0.1s;
        }

        .nav-button:hover {
            background-color: #d4a06b;
            transform: translateY(-1px);
        }

        .nav-button:disabled {
            background-color: #888;
            border-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* --- Calendar Button --- */

        .calendar-btn {
            background-color: var(--color-copper);
            color: white;
            border: 2px solid var(--color-border);
            padding: 8px 12px;
            cursor: pointer;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2em;
            border-radius: 50%;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            margin-left: 15px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-btn:hover {
            background-color: #d4a06b;
            transform: translateY(-1px) scale(1.05);
        }

        /* --- Toolbar --- */

        .toolbar-parchment {
            background-color: #e3d8c1; /* Lighter parchment tone for the toolbar */
            border: 1px solid var(--color-border);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
        }

        .toolbar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }

        .toolbar-row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
        }

        .tool-btn, .tool-dropdown {
            background-color: var(--color-ink);
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-family: 'Cormorant Garamond', serif;
            border-radius: 3px;
            transition: background-color 0.2s;
            font-size: 1em;
            line-height: 1;
        }

        .tool-btn:hover, .tool-dropdown:hover {
            background-color: var(--color-dark-ink);
        }

        .tool-btn.active {
            background-color: var(--color-copper);
            border: 2px solid var(--color-border);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tool-dropdown {
            /* Specific adjustment for select */
            padding-right: 20px; 
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M287%2069.4L146.2%20208.7L5.4%2069.4h281.6z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px top 50%;
            background-size: 0.65em auto;
        }

        .format-btn {
            font-weight: bold;
        }

        #underlineBtn {
            text-decoration: underline;
        }

        .settings-btn {
            background-color: transparent;
            border: 1px solid var(--color-ink);
            color: var(--color-ink);
            padding: 6px 10px;
            font-size: 0.9em;
        }

        .settings-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        #colorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 35px;
            background: transparent;
            border: 2px solid var(--color-ink);
            border-radius: 3px;
            cursor: pointer;
            padding: 1px;
        }

        #colorPicker::-webkit-color-swatch-wrapper { padding: 0; }
        #colorPicker::-webkit-color-swatch { border: none; border-radius: 2px; }

        /* --- Typical Colors Section --- */
        .typical-colors-section {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: auto;
            position: relative;
        }

        .preset-label {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.8em;
            color: #7a5a40;
            margin-right: 5px;
        }

        .preset-colors-row {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .preset-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .preset-swatch:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .preset-swatch:active {
            transform: scale(1.05);
        }

        /* Posicionar el primer color (negro) debajo del selector de color */
        .preset-swatch:first-child {
            position: relative;
            margin-left: 20px; /* Espacio para alinearse debajo del color picker */
        }

        /* Crear una l√≠nea visual que conecte el primer color con el selector */
        .preset-swatch:first-child::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 25px;
            background-color: #ccc;
            z-index: -1;
        }

        .separator {
            color: var(--color-ink);
            font-weight: bold;
        }

        /* --- Color Swatches --- */
        .recent-label {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.8em;
            color: #7a5a40;
            margin-right: 5px;
            margin-left: 5px;
        }

        #recentColorsContainer {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .color-swatch:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .color-swatch:active {
            transform: scale(1.05);
        }

        /* --- Modal for Custom Button --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--color-parchment);
            border: 3px solid var(--color-border);
            border-radius: 5px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.5em;
            color: var(--color-dark-ink);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-field {
            margin-bottom: 15px;
        }

        .modal-field label {
            display: block;
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--color-ink);
        }

        .modal-field input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 3px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1em;
            background-color: white;
            box-sizing: border-box;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-btn-save {
            background-color: var(--color-copper);
            color: white;
        }

        .modal-btn-save:hover {
            background-color: #d4a06b;
        }

        .modal-btn-cancel {
            background-color: #888;
            color: white;
        }

        .modal-btn-cancel:hover {
            background-color: #666;
        }

        /* --- Emoji Picker Styles --- */
        .emoji-input-wrap {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn-ghost {
            background: #f3e6cf;
            border: 1px solid #b5905e;
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-family: 'Cormorant Garamond', serif;
            transition: background-color 0.2s;
        }

        .btn-ghost:hover {
            background: #e8d5b7;
        }

        .popover {
            background: #fffaf0;
            border: 1px solid #c9b08a;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            z-index: 99999;
            position: fixed !important;
            top: 0;
            left: 0;
            transform: none !important;
        }

        .popover.hidden {
            display: none;
        }

        /* --- Editing Area (The Manuscript) --- */

        .editor-area {
            min-height: 400px;
            padding: 25px;
            line-height: 1.6;
            font-size: 1.1em;
            font-family: 'Crimson Text', serif;
            outline: none;
            border: 1px dashed var(--color-border); /* Subtle, non-intrusive border */
            background-color: var(--color-parchment);
            overflow-y: auto;
            cursor: text;
            white-space: pre-wrap; /* Allows text to wrap with font style */
            margin-bottom: 20px;
            user-select: text; /* Allow text selection only in editor area */
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        /* Font families for editor */
        .font-serif { font-family: 'Crimson Text', serif; }
        .font-handwriting { font-family: 'Cardo', serif; }
        .font-typewriter { font-family: 'Special Elite', monospace; }

        /* Placeholder for editable area (CSS trick) */
        .editor-area:empty:not(:focus):before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
            pointer-events: none;
            display: block;
        }

        /* Styles for Today I Learned text */
        .learned-today {
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin: 10px 0;
            padding: 10px;
            background-color: #fffacd; /* A subtle yellow, like an illuminator highlight */
            border-left: 5px solid #ffae42; /* A golden "rule" */
            font-weight: bold;
            font-style: italic;
            color: var(--color-ink);
            border-radius: 2px;
            position: relative;
            clear: both; /* Asegura que ocupe toda la fila */
        }

        /* Bot√≥n de eliminaci√≥n para Today I Learned */
        .learned-today-delete {
            position: absolute;
            top: 5px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
        }

        .learned-today:hover .learned-today-delete {
            opacity: 1;
        }

        .learned-today-delete:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }

        /* --- Footer --- */
        .journal-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid var(--color-copper);
            font-style: italic;
            font-size: 0.9em;
            color: var(--color-border);
        }

        /* --- Bot√≥n de recompensa diaria --- */
        .gold-btn {
            background: linear-gradient(145deg, #f4d03f, #f7dc6f);
            color: #8b4513;
            border: 2px solid #b8860b;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Cormorant Garamond', serif;
        }

        .gold-btn:hover {
            background: linear-gradient(145deg, #f7dc6f, #f4d03f);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .gold-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* --- Bot√≥n de Motivation (celeste con letras azules) --- */
        .motivation-btn {
            background: linear-gradient(145deg, #87ceeb, #b0e0e6);
            color: #0066cc;
            border: 2px solid #4682b4;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Cormorant Garamond', serif;
        }

        .motivation-btn:hover {
            background: linear-gradient(145deg, #b0e0e6, #87ceeb);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .motivation-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* --- Bot√≥n de Image (verde claro con letras verde oscuro) --- */
        .image-btn {
            background: linear-gradient(145deg, #98fb98, #90ee90);
            color: #006400;
            border: 2px solid #228b22;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Cormorant Garamond', serif;
        }

        .image-btn:hover {
            background: linear-gradient(145deg, #90ee90, #98fb98);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .image-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* --- Contenedor de im√°genes del diario --- */
        .diary-images {
            margin: 20px 0;
        }

        .diary-images-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Tama√±o fijo para todas las im√°genes (igual que cuando hay 3) */
        .diary-images-row .diary-image {
            width: 250px;
            height: 250px;
        }

        .diary-image {
            position: relative;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .diary-image:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .diary-image img {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }

        .diary-image-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }

        .diary-image:hover .diary-image-delete {
            opacity: 1;
        }

        .diary-image-delete:hover {
            background: rgba(255, 0, 0, 0.9);
            transform: scale(1.1);
        }

        /* --- Modal para l√≠mite de im√°genes --- */
        .image-limit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .image-limit-modal.active {
            display: flex;
        }

        .image-limit-content {
            background-color: var(--color-parchment);
            border: 3px solid var(--color-border);
            border-radius: 5px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .image-limit-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.5em;
            color: var(--color-dark-ink);
            margin-bottom: 15px;
        }

        .image-limit-message {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1em;
            color: var(--color-ink);
            margin-bottom: 20px;
        }

        /* === ESTILOS PARA FRASES MOTIVACIONALES === */
        
        /* Estilos para el modal de motivaci√≥n */
        .motivation-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 15px;
            background-color: var(--color-parchment);
        }

        .motivation-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 5px;
        }

        .motivation-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .motivation-text {
            flex: 1;
            font-family: 'Cormorant Garamond', serif;
            font-size: 14px;
            line-height: 1.4;
        }

        .motivation-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .motivation-btn-small {
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .motivation-btn-small:hover {
            background-color: var(--color-border);
        }

        .motivation-btn-small.edit {
            color: #0066cc;
        }

        .motivation-btn-small.delete {
            color: #cc0000;
        }

        .motivation-btn-small.insert {
            color: #00aa00;
        }

        /* Estilo para las frases motivacionales en el diario */
        .motivation-entry {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f8ff; /* Azul claro suave */
            border-left: 5px solid #4682b4; /* Azul acero */
            border-radius: 2px;
            font-family: 'Cormorant Garamond', serif;
            position: relative;
        }

        .motivation-hero-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            cursor: pointer;
            transition: transform 0.2s;
            object-fit: cover;
            border: 2px solid var(--color-border);
        }

        .motivation-hero-avatar:hover {
            transform: scale(1.1);
        }

        .motivation-quote {
            flex: 1;
            font-style: italic;
            color: var(--color-ink);
            font-size: 16px;
        }

        .motivation-delete {
            position: absolute;
            top: 5px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
        }

        .motivation-entry:hover .motivation-delete {
            opacity: 1;
        }

        .motivation-delete:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .modal-btn-secondary {
            background: linear-gradient(145deg, #87ceeb, #b0e0e6);
            color: #0066cc;
            border: 2px solid #4682b4;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Cormorant Garamond', serif;
        }

        .modal-btn-secondary:hover {
            background: linear-gradient(145deg, #b0e0e6, #87ceeb);
            transform: translateY(-1px);
        }

        #motivationInput {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }

        #motivationInput:focus {
            outline: none;
            border-color: #4682b4;
            box-shadow: 0 0 5px rgba(70, 130, 180, 0.3);
        }

        /* --- Calendar Modal --- */

        .calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .calendar-modal.active {
            display: flex;
        }

        .calendar-content {
            background-color: var(--color-parchment);
            border: 3px solid var(--color-border);
            border-radius: 5px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            width: 90%;
        }

        .calendar-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.5em;
            color: var(--color-dark-ink);
            margin-bottom: 20px;
            text-align: center;
        }

        .calendar-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav-btn {
            background-color: var(--color-copper);
            color: white;
            border: 2px solid var(--color-border);
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Cormorant Garamond', serif;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .calendar-nav-btn:hover {
            background-color: #d4a06b;
        }

        .calendar-nav-btn:disabled {
            background-color: #888;
            cursor: not-allowed;
        }

        .calendar-month-year {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--color-ink);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 8px 4px;
            font-size: 0.9em;
            color: var(--color-border);
            font-family: 'Cormorant Garamond', serif;
        }

        .calendar-day {
            text-align: center;
            padding: 8px 4px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            font-family: 'Cormorant Garamond', serif;
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background-color: var(--color-copper);
            color: white;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.disabled:hover {
            background-color: transparent;
            color: #ccc;
        }

        .calendar-day.current {
            background-color: var(--color-dark-ink);
            color: white;
            font-weight: bold;
        }

        .calendar-day.today {
            border: 2px solid var(--color-copper);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="journal-container">
        <header class="journal-header">
            <!-- Fecha con bot√≥n de calendario -->
            <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 15px; position: relative;">
                <h2 id="currentDate" class="date-script">Sunday, October 26, 2025</h2>
                <button id="calendarBtn" class="calendar-btn" title="Jump to date">üìÖ</button>
            </div>
            
            <!-- Todos los botones en la misma fila -->
            <div class="buttons-row" style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <button id="prevDay" class="nav-button">‚óÄÔ∏è Previous Day</button>
                <button id="motivationBtn" class="motivation-btn">üí¨ Motivation</button>
                <button id="reward-btn" class="gold-btn">üí∞ Claim 10,000 Gold</button>
                <button id="imageBtn" class="image-btn">Image üñºÔ∏è</button>
                <button id="nextDay" class="nav-button">Next Day ‚ñ∂Ô∏è</button>
            </div>
        </header>
        
        <div class="toolbar-parchment">
            <div id="toolbar" class="toolbar">
                <!-- Row 1: Typography Styles + Colors -->
                <div class="toolbar-row">
                    <button id="boldBtn" class="tool-btn format-btn" title="Bold">ùêÅ</button>
                    <button id="italicBtn" class="tool-btn format-btn" title="Italic">ùë∞</button>
                    <button id="underlineBtn" class="tool-btn format-btn" title="Underline">ùêî</button>
                
                <span class="separator">|</span>

                    <select id="fontSelector" class="tool-dropdown" title="Font Family">
                        <option value="serif">Serif</option>
                        <option value="handwriting">Handwriting</option>
                        <option value="typewriter">Typewriter</option>
                </select>

                <span class="separator">|</span>

                    <span style="color: #7a5a40; font-size: 0.9em;">üé®</span>
                    <input type="color" id="colorPicker" title="Ink Color">
                    
                    <span class="recent-label">Recent:</span>
                    <div id="recentColorsContainer"></div>
                </div>
                
                <!-- Row 2: Functional Buttons + Typical Colors -->
                <div class="toolbar-row">
                    <button id="customBtn" class="tool-btn learned-btn" title="Custom Quick Entry">üß† Today I Learned</button>
                    <button id="settingsBtn" class="settings-btn" title="Customize Button">‚öôÔ∏è</button>
                    <button id="emojiBtn" class="settings-btn" title="Insert Emoji">üòÄ</button>
                    
                    <div class="typical-colors-section">
                        <span class="preset-label">Typical:</span>
                        <div id="presetColorsContainer" class="preset-colors-row"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="editor" class="editor-area" contenteditable="true" data-placeholder="Write your daily chronicles here...">
        </div>

        <footer class="journal-footer">
            <p>~ End of Chronicle ~</p>
        </footer>

    </div>

    <!-- Modal for customizing button -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Customize Quick Entry</h2>
            <div class="modal-field">
                <label for="emojiInput">Emoji:</label>
                <div class="emoji-input-wrap">
                    <input type="text" id="emojiInput" maxlength="2" placeholder="üß†">
                    <button id="openEmojiPicker" type="button" class="btn-ghost">üôÇ</button>
                </div>
            </div>
            <div class="modal-field">
                <label for="textInput">Text:</label>
                <input type="text" id="textInput" placeholder="Today I Learned">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modalCancel">Cancel</button>
                <button class="modal-btn modal-btn-save" id="modalSave">Save</button>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Popover for Modal -->
    <div id="emojiPickerWrap" class="popover hidden">
        <emoji-picker id="emojiPicker" locale="en"></emoji-picker>
    </div>

    <!-- Emoji Picker Popover for Toolbar -->
    <div id="toolbarEmojiPickerWrap" class="popover hidden">
        <emoji-picker id="toolbarEmojiPicker" locale="en"></emoji-picker>
    </div>

    <!-- Modal para l√≠mite de im√°genes -->
    <div id="imageLimitModal" class="image-limit-modal">
        <div class="image-limit-content">
            <h2 class="image-limit-title">Image Limit Reached</h2>
            <p class="image-limit-message">You can only add a maximum of 3 images per day.</p>
            <button class="modal-btn modal-btn-save" onclick="closeImageLimitModal()">Understood</button>
        </div>
    </div>

    <!-- Modal para Frases Motivacionales -->
    <div id="motivationModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Motivational Phrases Management</h2>
            
            <!-- Lista de frases existentes -->
            <div class="modal-field">
                <label>Existing Phrases:</label>
                <div id="motivationList" class="motivation-list">
                    <!-- Las frases se cargar√°n aqu√≠ din√°micamente -->
                </div>
            </div>
            
            <!-- Nueva frase -->
            <div class="modal-field">
                <label for="motivationInput">New Phrase:</label>
                <textarea id="motivationInput" placeholder="Write your motivational phrase here..." maxlength="200" rows="3"></textarea>
            </div>
            
            <!-- Botones de acci√≥n -->
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="addMotivationBtn">Add</button>
                <button class="modal-btn modal-btn-secondary" id="insertRandomBtn">Insert Random</button>
                <button class="modal-btn modal-btn-cancel" id="motivationModalCancel">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal para Calendario -->
    <div id="calendarModal" class="calendar-modal">
        <div class="calendar-content">
            <h2 class="calendar-title">Jump to Date</h2>
            
            <!-- Navegaci√≥n de mes/a√±o -->
            <div class="calendar-navigation">
                <button id="calendarPrevMonth" class="calendar-nav-btn">‚óÄ</button>
                <div id="calendarMonthYear" class="calendar-month-year">October 2025</div>
                <button id="calendarNextMonth" class="calendar-nav-btn">‚ñ∂</button>
            </div>
            
            <!-- Grid del calendario -->
            <div id="calendarGrid" class="calendar-grid">
                <!-- Los d√≠as se generar√°n din√°micamente -->
            </div>
            
            <!-- Botones de acci√≥n -->
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="calendarModalCancel">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ==================================
        //         FUNCTIONALITY (JS)
        // ==================================

        // ========================================
        // SISTEMA DE SINCRONIZACI√ìN CON HABITSCALENDAR.JSON
        // ========================================

        // Funci√≥n para recopilar todos los datos del calendario de h√°bitos desde localStorage
        function collectHabitsCalendarData() {
            const habitsData = {
                diaryEntries: {},
                diaryImages: {},
                customEntryButton: JSON.parse(localStorage.getItem('customEntryButton') || '{"emoji":"üß†","text":"Today I Learned"}'),
                recentColors: JSON.parse(localStorage.getItem('recentColors') || '[]'),
                dailyRewards: JSON.parse(localStorage.getItem('dailyRewards') || '{}'),
                motivationalPhrases: JSON.parse(localStorage.getItem('motivationalPhrases') || '[]')
            };

            // Recopilar todas las entradas del diario
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('diary_')) {
                    if (key.includes('diary_images_')) {
                        habitsData.diaryImages[key] = JSON.parse(localStorage.getItem(key) || '[]');
                    } else {
                        habitsData.diaryEntries[key] = localStorage.getItem(key);
                    }
                }
            }

            return habitsData;
        }

        // Funci√≥n para sincronizar datos del calendario de h√°bitos con el sistema de guardado
        function syncHabitsCalendarWithSave() {
            const habitsData = collectHabitsCalendarData();
            
            // Enviar datos al sistema de guardado del juego
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'syncHabitsCalendar',
                    data: habitsData
                }, '*');
            }
        }

        // Funci√≥n para cargar datos del calendario de h√°bitos desde el sistema de guardado
        function loadHabitsCalendarFromSave(habitsData) {
            if (!habitsData) return;

            // Cargar entradas del diario
            if (habitsData.diaryEntries) {
                Object.keys(habitsData.diaryEntries).forEach(key => {
                    localStorage.setItem(key, habitsData.diaryEntries[key]);
                });
            }

            // Cargar im√°genes del diario
            if (habitsData.diaryImages) {
                Object.keys(habitsData.diaryImages).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(habitsData.diaryImages[key]));
                });
            }

            // Cargar configuraci√≥n del bot√≥n personalizado
            if (habitsData.customEntryButton) {
                localStorage.setItem('customEntryButton', JSON.stringify(habitsData.customEntryButton));
                updateCustomButton();
            }

            // Cargar colores recientes
            if (habitsData.recentColors) {
                localStorage.setItem('recentColors', JSON.stringify(habitsData.recentColors));
                renderRecentColors();
            }

            // Cargar recompensas diarias
            if (habitsData.dailyRewards) {
                localStorage.setItem('dailyRewards', JSON.stringify(habitsData.dailyRewards));
                // Actualizar estado del bot√≥n de recompensa
                updateRewardButtonState();
            }

            // Cargar frases motivacionales
            if (habitsData.motivationalPhrases) {
                localStorage.setItem('motivationalPhrases', JSON.stringify(habitsData.motivationalPhrases));
                motivationalPhrases = habitsData.motivationalPhrases;
            }
        }

        // Funci√≥n para actualizar el estado del bot√≥n de recompensa
        function updateRewardButtonState() {
            const rewardBtn = document.getElementById('reward-btn');
            if (rewardBtn) {
                const today = new Date().toISOString().split('T')[0];
                const dailyRewards = JSON.parse(localStorage.getItem('dailyRewards') || '{}');
                const claimedToday = dailyRewards[today];
                
                if (claimedToday) {
                    rewardBtn.textContent = 'üí∞ Claimed 10,000 Gold';
                    rewardBtn.disabled = true;
                } else {
                    rewardBtn.textContent = 'üí∞ Claim 10,000 Gold';
                    rewardBtn.disabled = false;
                }
            }
        }

        // Cargar datos desde el sistema de guardado del juego
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'loadData') {
                if (event.data.diaryEntries) {
                    // Cargar entradas del diary
                    Object.keys(event.data.diaryEntries).forEach(key => {
                        localStorage.setItem(key, event.data.diaryEntries[key]);
                    });
                    // Actualizar la vista actual
                    updateDiaryView();
                }
                
                // Cargar datos del calendario de h√°bitos si est√°n disponibles
                if (event.data.habitsCalendarData) {
                    loadHabitsCalendarFromSave(event.data.habitsCalendarData);
                    updateDiaryView();
                }
            }
            
            // Manejar respuestas de operaciones de im√°genes
            if (event.data && event.data.type === 'diary:image-selected') {
                if (event.data.success && event.data.imagePath) {
                    currentDayImages.push(event.data.imagePath);
                    saveCurrentDayImages();
                    renderDiaryImages();
                } else if (event.data.error) {
                    alert('Error adding image: ' + event.data.error);
                }
            }
            
            if (event.data && event.data.type === 'diary:image-deleted') {
                if (event.data.success) {
                    const index = event.data.imageIndex;
                    if (index >= 0 && index < currentDayImages.length) {
                        currentDayImages.splice(index, 1);
                        saveCurrentDayImages();
                        renderDiaryImages();
                    }
                } else if (event.data.error) {
                    console.error('Error deleting image:', event.data.error);
                }
            }
        });

        // Solicitar datos al cargar
        if (window.parent) {
            window.parent.postMessage({ type: 'requestData' }, '*');
            // Tambi√©n solicitar datos espec√≠ficos del calendario de h√°bitos
            window.parent.postMessage({ type: 'requestHabitsCalendarData' }, '*');
        }

        // Constants for DOM elements
        const currentDateEl = document.getElementById('currentDate');
        const editorEl = document.getElementById('editor');
        const prevDayBtn = document.getElementById('prevDay');
        const nextDayBtn = document.getElementById('nextDay');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const colorPicker = document.getElementById('colorPicker');
        const customBtn = document.getElementById('customBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const fontSelector = document.getElementById('fontSelector');
        const recentColorsContainer = document.getElementById('recentColorsContainer');
        const presetColorsContainer = document.getElementById('presetColorsContainer');
        const customModal = document.getElementById('customModal');
        const emojiInput = document.getElementById('emojiInput');
        const textInput = document.getElementById('textInput');
        const modalSave = document.getElementById('modalSave');
        const modalCancel = document.getElementById('modalCancel');
        const openEmojiPicker = document.getElementById('openEmojiPicker');
        const emojiPickerWrap = document.getElementById('emojiPickerWrap');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiBtn = document.getElementById('emojiBtn');
        const toolbarEmojiPickerWrap = document.getElementById('toolbarEmojiPickerWrap');
        const toolbarEmojiPicker = document.getElementById('toolbarEmojiPicker');

        // State variable for current displayed date (initialized to today)
        let currentDate = new Date();
        currentDate.setHours(0, 0, 0, 0); // Normalize to midnight

        // Maximum number of recent colors to display
        const MAX_RECENT_COLORS = 5;

        // Variables para manejo de im√°genes del diario
        let currentDayImages = [];
        const MAX_IMAGES_PER_DAY = 3;

        // Elementos del DOM para im√°genes
        const imageLimitModal = document.getElementById('imageLimitModal');

        // Preset color palette (2 columns layout)
        const presetColors = [
            '#000000', // black
            '#1E90FF', // blue
            '#FF0000', // red
            '#228B22', // green
            '#FFD700', // gold
            '#800080', // purple
            '#FFFFFF', // white
            '#FF8C00'  // orange
        ];

        // --- Utility and Date Functions ---

        /**
         * Formats a Date object to the desired format: "Tuesday, October 14, 2025"
         * @param {Date} date - The date to format.
         * @returns {string} The formatted date.
         */
        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formatted = date.toLocaleDateString('en-US', options);
            return formatted;
        }

        /**
         * Generates a unique key for localStorage based on the date.
         * @param {Date} date - The date.
         * @returns {string} The storage key (Ex: "diary_2025-10-14").
         */
        function getStorageKey(date) {
            return `diary_${date.toISOString().split('T')[0]}`;
        }

        /**
         * Updates the DOM with the current date and loads saved content.
         */
        function updateDiaryView() {
            const formattedDate = formatDate(currentDate);
            currentDateEl.textContent = formattedDate;

            const key = getStorageKey(currentDate);
            const content = localStorage.getItem(key) || ''; // Load content or empty

            editorEl.innerHTML = content;
            
            // Cargar im√°genes del d√≠a actual
            currentDayImages = getCurrentDayImages();
            renderDiaryImages();
            
            // This ensures the Next Day button is disabled if it's today
            checkNextDayButton();
        }

        /**
         * Saves the current content of the editor to localStorage.
         */
        function saveContent() {
            const key = getStorageKey(currentDate);
            // Use innerHTML to save formatting (bold, italic, etc.)
            localStorage.setItem(key, editorEl.innerHTML);
            
            // Sincronizar con habitscalendar.json
            syncHabitsCalendarWithSave();
        }

        // --- Navigation and Events ---

        /**
         * Navigates to the previous day, saves current content and updates the view.
         */
        function goToPreviousDay() {
            saveContent(); // Save before changing
            currentDate.setDate(currentDate.getDate() - 1);
            updateDiaryView();
        }

        /**
         * Navigates to the next day, saves current content and updates the view.
         */
        function goToNextDay() {
            // Prevent going beyond the current day (can't write the future)
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to midnight for comparison

            // Only allow advancing if the current view date is strictly before today
            if (currentDate.getTime() < today.getTime()) {
                saveContent(); // Save before changing
                currentDate.setDate(currentDate.getDate() + 1);
                updateDiaryView();
            }
        }

        /**
         * Enables or disables the Next Day button if it's today.
         */
        function checkNextDayButton() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            const currentViewDate = new Date(currentDate); // Copy
            currentViewDate.setHours(0, 0, 0, 0);

            // Disable if current view date is equal to or later than today
            nextDayBtn.disabled = currentViewDate.getTime() >= today.getTime();
        }

        // --- Formatting Functionality (Rich Text) ---

        /**
         * Applies formatting to selected text in the editor.
         * @param {string} command - Formatting command (Ex: 'bold', 'italic', 'foreColor').
         * @param {string} [value=null] - Value for the command (Ex: color code).
         */
        function formatText(command, value = null) {
            // document.execCommand is the standard way to apply formatting to contentEditable
            document.execCommand(command, false, value);
            // Needed so focus returns to editor after a toolbar click
            editorEl.focus();
            saveContent(); // Save when applying format
            updateButtonStates(); // Update visual state of buttons
        }

        /**
         * Updates the visual state of format buttons based on current selection.
         */
        function updateButtonStates() {
            // Check if bold is active
            boldBtn.classList.toggle('active', document.queryCommandState('bold'));
            // Check if italic is active
            italicBtn.classList.toggle('active', document.queryCommandState('italic'));
            // Check if underline is active
            underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
        }

        /**
         * Inserts a custom marker with special styling based on user preferences.
         */
        function insertCustomTag() {
            const customConfig = loadCustomButton();
            
            // Crear un ID √∫nico para esta entrada
            const entryId = 'learned_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            editorEl.focus();
            
            // Forzar nueva l√≠nea si hay contenido antes del cursor
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                // Obtener el texto antes del cursor en la l√≠nea actual
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(editorEl);
                preCaretRange.setEnd(range.startContainer, range.startOffset);
                const textBeforeCursor = preCaretRange.toString();
                
                // Si hay texto antes del cursor y no termina con salto de l√≠nea
                if (textBeforeCursor.length > 0 && !textBeforeCursor.endsWith('\n')) {
                    document.execCommand('insertHTML', false, '<br>');
                }
            }
            
            // Create a special div for CSS styling with delete button
            const learnedHtml = `<div class="learned-today" data-entry-id="${entryId}">${customConfig.emoji} ${customConfig.text}: <button class="learned-today-delete" onclick="removeLearnedTodayEntry('${entryId}')" title="Delete">üóëÔ∏è</button></div><br>`;
            document.execCommand('insertHTML', false, learnedHtml);
            saveContent();
        }

        // Funci√≥n global para eliminar entrada "Today I Learned" (llamada desde HTML)
        window.removeLearnedTodayEntry = function(entryId) {
            const entry = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entry) {
                // Tambi√©n remover el <br> siguiente si existe
                const nextElement = entry.nextElementSibling;
                if (nextElement && nextElement.tagName === 'BR') {
                    nextElement.remove();
                }
                entry.remove();
                saveContent();
            }
        };

        // --- Custom Button Management ---

        /**
         * Loads custom button configuration from localStorage.
         * @returns {Object} Configuration with emoji and text.
         */
        function loadCustomButton() {
            const saved = localStorage.getItem('customEntryButton');
            return saved ? JSON.parse(saved) : { emoji: 'üß†', text: 'Today I Learned' };
        }

        /**
         * Saves custom button configuration to localStorage.
         * @param {string} emoji - The emoji to use.
         * @param {string} text - The text to display.
         */
        function saveCustomButton(emoji, text) {
            localStorage.setItem('customEntryButton', JSON.stringify({ emoji, text }));
            updateCustomButton();
            
            // Sincronizar con habitscalendar.json
            syncHabitsCalendarWithSave();
        }

        /**
         * Updates the custom button display with current configuration.
         */
        function updateCustomButton() {
            const config = loadCustomButton();
            customBtn.innerHTML = `${config.emoji} ${config.text}`;
        }

        /**
         * Opens the customization modal.
         */
        function openModal() {
            const config = loadCustomButton();
            emojiInput.value = config.emoji;
            textInput.value = config.text;
            customModal.classList.add('active');
            // Hide emoji picker if it's open
            emojiPickerWrap.classList.add('hidden');
        }

        /**
         * Closes the customization modal.
         */
        function closeModal() {
            customModal.classList.remove('active');
        }

        /**
         * Saves the modal inputs and closes it.
         */
        function saveModal() {
            const emoji = emojiInput.value.trim() || 'üß†';
            const text = textInput.value.trim() || 'Today I Learned';
            saveCustomButton(emoji, text);
            closeModal();
        }

        // --- Emoji Picker Management ---

        /**
         * Toggles the emoji picker visibility and positions it.
         * For the modal emoji picker - position to the right and centered.
         */
        function toggleEmojiPicker() {
            emojiPickerWrap.classList.toggle('hidden');
            
            if (!emojiPickerWrap.classList.contains('hidden')) {
                // Position the popover to the right of the button and centered
                const rect = openEmojiPicker.getBoundingClientRect();
                emojiPickerWrap.style.position = 'fixed';
                emojiPickerWrap.style.zIndex = '99999';
                emojiPickerWrap.style.transform = 'none';
                
                // Position to the right of the button
                emojiPickerWrap.style.left = `${rect.right + 8}px`;
                
                // Center vertically with the button
                const pickerHeight = 400; // Approximate emoji picker height
                const buttonHeight = rect.height;
                const centerOffset = (pickerHeight - buttonHeight) / 2;
                emojiPickerWrap.style.top = `${rect.top - centerOffset}px`;
                
                // Ensure it stays in viewport
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const pickerWidth = 320; // Approximate emoji picker width
                
                // Adjust horizontal position if it would go off screen
                if (rect.right + pickerWidth + 8 > viewportWidth) {
                    emojiPickerWrap.style.left = `${rect.left - pickerWidth - 8}px`;
                }
                
                // Adjust vertical position if it would go off screen
                if (rect.top - centerOffset < 0) {
                    emojiPickerWrap.style.top = '10px';
                } else if (rect.top - centerOffset + pickerHeight > viewportHeight) {
                    emojiPickerWrap.style.top = `${viewportHeight - pickerHeight - 10}px`;
                }
            }
        }

        /**
         * Handles emoji selection from the modal picker.
         */
        function handleEmojiSelection(event) {
            emojiInput.value = event.detail.unicode;
            emojiPickerWrap.classList.add('hidden');
            emojiInput.focus();
        }

        /**
         * Toggles the toolbar emoji picker visibility and positions it.
         * For the main toolbar emoji picker - ALWAYS position below the button.
         */
        function toggleToolbarEmojiPicker() {
            toolbarEmojiPickerWrap.classList.toggle('hidden');
            
            if (!toolbarEmojiPickerWrap.classList.contains('hidden')) {
                // Position the popover below the button with fixed positioning
                const rect = emojiBtn.getBoundingClientRect();
                toolbarEmojiPickerWrap.style.position = 'fixed';
                toolbarEmojiPickerWrap.style.zIndex = '99999';
                toolbarEmojiPickerWrap.style.transform = 'none';
                
                // ALWAYS position below the button - no exceptions
                toolbarEmojiPickerWrap.style.left = `${rect.left}px`;
                toolbarEmojiPickerWrap.style.top = `${rect.bottom + 8}px`;
                
                // Ensure it stays in viewport horizontally
                const viewportWidth = window.innerWidth;
                const pickerWidth = 320; // Approximate emoji picker width
                
                // Adjust horizontal position if it would go off screen
                if (rect.left + pickerWidth > viewportWidth) {
                    toolbarEmojiPickerWrap.style.left = `${viewportWidth - pickerWidth - 10}px`;
                }
                
                // If it would go off screen below, scroll the page to make room
                const viewportHeight = window.innerHeight;
                const pickerHeight = 400; // Approximate emoji picker height
                
                if (rect.bottom + pickerHeight + 8 > viewportHeight) {
                    // Scroll down to make room for the picker
                    const scrollAmount = (rect.bottom + pickerHeight + 8) - viewportHeight + 20;
                    window.scrollBy(0, scrollAmount);
                    
                    // Reposition after scrolling
                    setTimeout(() => {
                        const newRect = emojiBtn.getBoundingClientRect();
                        toolbarEmojiPickerWrap.style.top = `${newRect.bottom + 8}px`;
                    }, 100);
                }
            }
        }

        /**
         * Handles emoji selection from the toolbar picker.
         */
        function handleToolbarEmojiSelection(event) {
            // Insert emoji at cursor position in editor
            editorEl.focus();
            document.execCommand('insertText', false, event.detail.unicode);
            toolbarEmojiPickerWrap.classList.add('hidden');
            saveContent();
        }

        // --- Font and Size Management ---

        /**
         * Changes the font family of the editor.
         * @param {string} fontType - The font type (serif, handwriting, typewriter).
         */
        function changeFont(fontType) {
            // Remove all font classes
            editorEl.classList.remove('font-serif', 'font-handwriting', 'font-typewriter');
            // Add the selected font class
            editorEl.classList.add(`font-${fontType}`);
        }

        // --- Recent Colors Management ---

        /**
         * Gets the list of recent colors from localStorage.
         * @returns {Array} Array of color hex codes.
         */
        function getRecentColors() {
            const colors = localStorage.getItem('recentColors');
            return colors ? JSON.parse(colors) : [];
        }

        /**
         * Saves a color to the recent colors list.
         * @param {string} color - The hex color code.
         */
        function addRecentColor(color) {
            let recentColors = getRecentColors();
            
            // Remove the color if it already exists (to move it to front)
            recentColors = recentColors.filter(c => c.toLowerCase() !== color.toLowerCase());
            
            // Add the new color at the beginning
            recentColors.unshift(color);
            
            // Keep only the maximum number of colors
            recentColors = recentColors.slice(0, MAX_RECENT_COLORS);
            
            // Save to localStorage
            localStorage.setItem('recentColors', JSON.stringify(recentColors));
            
            // Update the display
            renderRecentColors();
            
            // Sincronizar con habitscalendar.json
            syncHabitsCalendarWithSave();
        }

        /**
         * Renders the recent color swatches in the DOM.
         */
        function renderRecentColors() {
            const recentColors = getRecentColors();
            recentColorsContainer.innerHTML = '';
            
            recentColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.title = color;
                swatch.addEventListener('click', () => {
                    formatText('foreColor', color);
                    // Update the color picker to show the selected color
                    colorPicker.value = color;
                });
                recentColorsContainer.appendChild(swatch);
            });
        }

        /**
         * Renders the preset color swatches in the DOM.
         */
        function renderPresetColors() {
            presetColorsContainer.innerHTML = '';
            
            presetColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'preset-swatch';
                swatch.style.backgroundColor = color;
                swatch.title = color;
                swatch.addEventListener('click', () => {
                    formatText('foreColor', color);
                    // Update the color picker to show the selected color
                    colorPicker.value = color;
                    // Add to recent colors
                    addRecentColor(color);
                });
                presetColorsContainer.appendChild(swatch);
            });
        }

        // --- Image Management Functions ---

        /**
         * Funci√≥n para cerrar modal de l√≠mite de im√°genes
         */
        function closeImageLimitModal() {
            imageLimitModal.classList.remove('active');
        }

        // Hacer la funci√≥n disponible globalmente para el onclick del HTML
        window.closeImageLimitModal = closeImageLimitModal;

        /**
         * Funci√≥n para obtener im√°genes del d√≠a actual
         */
        function getCurrentDayImages() {
            const key = `diary_images_${getStorageKey(currentDate)}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }

        /**
         * Funci√≥n para guardar im√°genes del d√≠a actual
         */
        function saveCurrentDayImages() {
            const key = `diary_images_${getStorageKey(currentDate)}`;
            localStorage.setItem(key, JSON.stringify(currentDayImages));
            
            // Sincronizar con habitscalendar.json
            syncHabitsCalendarWithSave();
        }

        /**
         * Funci√≥n para insertar imagen en el diario
         */
        async function insertDiaryImage() {
            if (currentDayImages.length >= MAX_IMAGES_PER_DAY) {
                imageLimitModal.classList.add('active');
                return;
            }

            try {
                // Comunicarse con la ventana padre a trav√©s de postMessage
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'diary:select-image',
                        date: currentDate.toISOString(),
                        imageIndex: currentDayImages.length + 1
                    }, '*');
                } else {
                    alert('Image functionality is only available in the desktop version.');
                }
            } catch (error) {
                console.error('Error requesting image selection:', error);
                alert('Error requesting image selection');
            }
        }

        /**
         * Funci√≥n para eliminar imagen del diario
         */
        async function deleteDiaryImage(index) {
            const imagePath = currentDayImages[index];
            try {
                // Comunicarse con la ventana padre a trav√©s de postMessage
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'diary:delete-image',
                        imagePath: imagePath,
                        imageIndex: index
                    }, '*');
                } else {
                    // Fallback para versi√≥n web - solo remover de la lista
                    currentDayImages.splice(index, 1);
                    saveCurrentDayImages();
                    renderDiaryImages();
                }
            } catch (error) {
                console.error('Error deleting diary image:', error);
            }
        }

        /**
         * Funci√≥n para renderizar im√°genes en el diario
         */
        function renderDiaryImages() {
            let imagesContainer = document.getElementById('diary-images-container');
            if (!imagesContainer) {
                imagesContainer = document.createElement('div');
                imagesContainer.id = 'diary-images-container';
                imagesContainer.className = 'diary-images';
                editorEl.parentNode.insertBefore(imagesContainer, editorEl);
            }

            imagesContainer.innerHTML = '';

            // Solo mostrar im√°genes si hay alguna
            if (currentDayImages.length > 0) {
                const imagesRow = document.createElement('div');
                imagesRow.className = 'diary-images-row';

                currentDayImages.forEach((imagePath, index) => {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'diary-image';

                    const img = document.createElement('img');
                    img.src = `file://${imagePath}`;
                    img.alt = `Diary image ${index + 1}`;
                    img.onerror = () => {
                        // Si la imagen no se puede cargar, mostrar placeholder
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4=';
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'diary-image-delete';
                    deleteBtn.innerHTML = 'üóëÔ∏è';
                    deleteBtn.onclick = () => deleteDiaryImage(index);
                    deleteBtn.title = 'Delete image';

                    imageDiv.appendChild(img);
                    imageDiv.appendChild(deleteBtn);
                    imagesRow.appendChild(imageDiv);
                });

                imagesContainer.appendChild(imagesRow);
            }
        }

        // --- Initialization ---

        // 1. Load initial view (current date)
        updateDiaryView(); 

        // 2. Event Listeners for navigation
        prevDayBtn.addEventListener('click', goToPreviousDay);
        nextDayBtn.addEventListener('click', goToNextDay);

        // 3. Event Listeners for toolbar
        boldBtn.addEventListener('click', () => formatText('bold'));
        italicBtn.addEventListener('click', () => formatText('italic'));
        underlineBtn.addEventListener('click', () => formatText('underline'));
        colorPicker.addEventListener('change', (e) => {
            const color = e.target.value;
            formatText('foreColor', color);
            addRecentColor(color);
        });
        customBtn.addEventListener('click', insertCustomTag);
        settingsBtn.addEventListener('click', openModal);
        emojiBtn.addEventListener('click', toggleToolbarEmojiPicker);
        fontSelector.addEventListener('change', (e) => changeFont(e.target.value));
        
        // Event listener para el bot√≥n de imagen
        imageBtn.addEventListener('click', insertDiaryImage);

        // 4. Event Listeners for modal
        modalSave.addEventListener('click', saveModal);
        modalCancel.addEventListener('click', closeModal);
        customModal.addEventListener('click', (e) => {
            // Close modal if clicking outside the content
            if (e.target === customModal) {
                closeModal();
            }
        });

        // Event listener para cerrar modal de l√≠mite de im√°genes
        imageLimitModal.addEventListener('click', (e) => {
            // Close modal if clicking outside the content
            if (e.target === imageLimitModal) {
                closeImageLimitModal();
            }
        });

        // 5. Event Listeners for emoji picker
        openEmojiPicker.addEventListener('click', toggleEmojiPicker);
        emojiPicker.addEventListener('emoji-click', handleEmojiSelection);
        toolbarEmojiPicker.addEventListener('emoji-click', handleToolbarEmojiSelection);
        
        // Hide emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!openEmojiPicker.contains(e.target) && !emojiPickerWrap.contains(e.target)) {
                emojiPickerWrap.classList.add('hidden');
            }
            if (!emojiBtn.contains(e.target) && !toolbarEmojiPickerWrap.contains(e.target)) {
                toolbarEmojiPickerWrap.classList.add('hidden');
            }
        });

        // Reposition emoji pickers on scroll to keep them fixed
        window.addEventListener('scroll', () => {
            if (!emojiPickerWrap.classList.contains('hidden')) {
                // Reposition modal emoji picker (to the right and centered)
                const rect = openEmojiPicker.getBoundingClientRect();
                emojiPickerWrap.style.left = `${rect.right + 8}px`;
                
                const pickerHeight = 400;
                const buttonHeight = rect.height;
                const centerOffset = (pickerHeight - buttonHeight) / 2;
                emojiPickerWrap.style.top = `${rect.top - centerOffset}px`;
                
                // Viewport adjustments
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const pickerWidth = 320;
                
                if (rect.right + pickerWidth + 8 > viewportWidth) {
                    emojiPickerWrap.style.left = `${rect.left - pickerWidth - 8}px`;
                }
                if (rect.top - centerOffset < 0) {
                    emojiPickerWrap.style.top = '10px';
                } else if (rect.top - centerOffset + pickerHeight > viewportHeight) {
                    emojiPickerWrap.style.top = `${viewportHeight - pickerHeight - 10}px`;
                }
            }
            if (!toolbarEmojiPickerWrap.classList.contains('hidden')) {
                // Reposition toolbar emoji picker (ALWAYS below the button)
                const rect = emojiBtn.getBoundingClientRect();
                toolbarEmojiPickerWrap.style.left = `${rect.left}px`;
                toolbarEmojiPickerWrap.style.top = `${rect.bottom + 8}px`;
                
                // Viewport adjustments
                const viewportWidth = window.innerWidth;
                const pickerWidth = 320;
                
                if (rect.left + pickerWidth > viewportWidth) {
                    toolbarEmojiPickerWrap.style.left = `${viewportWidth - pickerWidth - 10}px`;
                }
                
                // No vertical adjustments - always keep it below the button
                // The picker will be visible even if it goes off screen
            }
        });

        // 5. Listener to automatically save when typing and update button states
        // Use 'input' to save text changes
        editorEl.addEventListener('input', saveContent);
        
        // Update button states when selection changes
        editorEl.addEventListener('mouseup', updateButtonStates);
        editorEl.addEventListener('keyup', updateButtonStates);
        editorEl.addEventListener('focus', updateButtonStates);

        // 6. Initialize custom button, colors, and font settings
        updateCustomButton();
        renderRecentColors();
        renderPresetColors();
        changeFont('serif'); // Set default font
        updateButtonStates(); // Initialize button states

        // 7. Ensure Next button is properly disabled at startup
        checkNextDayButton();
        
        // 8. Sincronizaci√≥n inicial con habitscalendar.json
        // Permitir tiempo para que se carguen los datos del juego antes de sincronizar
        setTimeout(() => {
            syncHabitsCalendarWithSave();
        }, 1000);

        // 8. Bot√≥n de recompensa diaria
        const rewardBtn = document.getElementById('reward-btn');
        if (rewardBtn) {
            // Verificar si ya se reclam√≥ la recompensa hoy
            const today = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
            const dailyRewards = JSON.parse(localStorage.getItem('dailyRewards') || '{}');
            const claimedToday = dailyRewards[today];
            
            if (claimedToday) {
                rewardBtn.textContent = 'üí∞ Claimed 10,000 Gold';
                rewardBtn.disabled = true;
            } else {
                rewardBtn.onclick = () => {
                    // Comunicar con la ventana padre para dar oro
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'dailyReward',
                            amount: 10000
                        }, '*');
                    }
                    
                    // Marcar como reclamado hoy
                    dailyRewards[today] = true;
                    localStorage.setItem('dailyRewards', JSON.stringify(dailyRewards));
                    
                    // Actualizar el bot√≥n
                    rewardBtn.textContent = 'üí∞ Claimed 10,000 Gold';
                    rewardBtn.disabled = true;
                    
                    // Sincronizar con habitscalendar.json
                    syncHabitsCalendarWithSave();
                };
            }
        }

        // ========================================
        // SISTEMA DE FRASES MOTIVACIONALES
        // ========================================

        const motivationModal = document.getElementById('motivationModal');
        const motivationBtn = document.getElementById('motivationBtn');
        const motivationInput = document.getElementById('motivationInput');
        const motivationList = document.getElementById('motivationList');
        const addMotivationBtn = document.getElementById('addMotivationBtn');
        const insertRandomBtn = document.getElementById('insertRandomBtn');
        const motivationModalCancel = document.getElementById('motivationModalCancel');

        let motivationalPhrases = [];
        let currentlyEditingIndex = -1;
        let heroesData = null; // Para almacenar datos de h√©roes del juego

        // Cargar frases desde localStorage
        function loadMotivationalPhrases() {
            const saved = localStorage.getItem('motivationalPhrases');
            motivationalPhrases = saved ? JSON.parse(saved) : [
                "Every day is a new opportunity to grow.",
                "Your potential is infinite, you just need to discover it.",
                "Small daily steps lead to great transformations.",
                "You are stronger than you think, more capable than you imagine.",
                "Success is not the destination, it's the journey of personal growth.",
                "Every challenge is a disguised opportunity to prove your worth."
            ];
            saveMotivationalPhrases();
        }

        // Guardar frases en localStorage
        function saveMotivationalPhrases() {
            localStorage.setItem('motivationalPhrases', JSON.stringify(motivationalPhrases));
            
            // Sincronizar con habitscalendar.json
            syncHabitsCalendarWithSave();
        }

        // Renderizar lista de frases en el modal
        function renderMotivationList() {
            motivationList.innerHTML = '';
            
            if (motivationalPhrases.length === 0) {
                motivationList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No motivational phrases saved</div>';
                return;
            }
            
            motivationalPhrases.forEach((phrase, index) => {
                const item = document.createElement('div');
                item.className = 'motivation-item';
                
                const text = document.createElement('div');
                text.className = 'motivation-text';
                text.textContent = phrase;
                
                const actions = document.createElement('div');
                actions.className = 'motivation-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'motivation-btn-small edit';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = 'Edit';
                editBtn.onclick = () => editMotivation(index);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'motivation-btn-small delete';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.title = 'Delete';
                deleteBtn.onclick = () => deleteMotivation(index);
                
                const insertBtn = document.createElement('button');
                insertBtn.className = 'motivation-btn-small insert';
                insertBtn.textContent = '‚ûï';
                insertBtn.title = 'Insert in diary';
                insertBtn.onclick = () => insertMotivationToEditor(phrase);
                
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                actions.appendChild(insertBtn);
                
                item.appendChild(text);
                item.appendChild(actions);
                motivationList.appendChild(item);
            });
        }

        // Obtener h√©roe aleatorio con im√°genes
        function getRandomHeroWithImages() {
            // Si tenemos datos de h√©roes del juego, usar uno aleatorio
            if (heroesData && heroesData.length > 0) {
                const randomIndex = Math.floor(Math.random() * heroesData.length);
                return heroesData[randomIndex];
            }
            
            // Datos de fallback
            return {
                name: "Hero",
                avatar: "../Population/DefaultAvatar.png",
                secondImg: null,
                ability1Img: null,
                ability2Img: null
            };
        }

        // Insertar frase motivacional en el editor
        function insertMotivationToEditor(phrase) {
            const hero = getRandomHeroWithImages();
            
            // Crear un ID √∫nico para esta entrada motivacional
            const entryId = 'motivation_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            editorEl.focus();
            
            // Forzar nueva l√≠nea si hay contenido antes del cursor
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                // Obtener el texto antes del cursor en la l√≠nea actual
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(editorEl);
                preCaretRange.setEnd(range.startContainer, range.startOffset);
                const textBeforeCursor = preCaretRange.toString();
                
                // Si hay texto antes del cursor y no termina con salto de l√≠nea
                if (textBeforeCursor.length > 0 && !textBeforeCursor.endsWith('\n')) {
                    document.execCommand('insertHTML', false, '<br>');
                }
            }
            
            // Crear el HTML para la entrada motivacional
            const motivationHtml = `
                <div class="motivation-entry" data-entry-id="${entryId}">
                    <img class="motivation-hero-avatar" src="${hero.avatar || '../Population/DefaultAvatar.png'}" alt="${hero.name || 'Hero'}" onerror="this.src='../Population/DefaultAvatar.png'" data-hero-name="${hero.name || 'Hero'}">
                    <div class="motivation-quote">"${phrase}"</div>
                    <button class="motivation-delete" onclick="removeMotivationEntry('${entryId}')" title="Delete">üóëÔ∏è</button>
                </div><br>
            `;
            
            document.execCommand('insertHTML', false, motivationHtml);
            
            // Configurar el ciclo de im√°genes para la imagen insertada
            setTimeout(() => {
                setupHeroImageCycle(entryId, hero);
            }, 100);
            
            saveContent();
            closeMotivationModal();
        }

        // Configurar el ciclo de im√°genes para un h√©roe espec√≠fico
        function setupHeroImageCycle(entryId, hero) {
            const entry = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (!entry) return;
            
            const img = entry.querySelector('.motivation-hero-avatar');
            if (!img || img.availableImages) return; // Ya configurado
            
            // Crear array de im√°genes disponibles
            const availableImages = [];
            
            if (hero.avatar) {
                availableImages.push({ src: hero.avatar, name: 'Avatar' });
            } else {
                availableImages.push({ src: '../Population/DefaultAvatar.png', name: 'Avatar' });
            }
            
            if (hero.secondImg) {
                availableImages.push({ src: hero.secondImg, name: '2nd Image' });
            }
            
            if (hero.ability1Img) {
                availableImages.push({ src: hero.ability1Img, name: 'Ability 1' });
            }
            
            if (hero.ability2Img) {
                availableImages.push({ src: hero.ability2Img, name: 'Ability 2' });
            }
            
            // Configurar propiedades del ciclo
            img.currentImageIndex = 0;
            img.availableImages = availableImages;
            
            // Agregar evento de clic para ciclar im√°genes
            img.addEventListener('click', function() {
                if (this.availableImages.length > 1) {
                    this.currentImageIndex = (this.currentImageIndex + 1) % this.availableImages.length;
                    const newImage = this.availableImages[this.currentImageIndex];
                    this.src = newImage.src;
                    this.onerror = () => this.src = '../Population/DefaultAvatar.png';
                    console.log(`${this.dataset.heroName}: Cambiando a ${newImage.name}`);
                    saveContent();
                }
            });
        }

        // Funci√≥n global para eliminar entrada motivacional (llamada desde HTML)
        window.removeMotivationEntry = function(entryId) {
            const entry = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entry) {
                // Tambi√©n remover el <br> siguiente si existe
                const nextElement = entry.nextElementSibling;
                if (nextElement && nextElement.tagName === 'BR') {
                    nextElement.remove();
                }
                entry.remove();
                saveContent();
            }
        };

        // Abrir modal de motivaci√≥n
        function openMotivationModal() {
            loadMotivationalPhrases();
            renderMotivationList();
            motivationModal.classList.add('active');
            
            // Solicitar datos de h√©roes si no los tenemos
            if (!heroesData && window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'requestHeroesDataForMotivation' }, '*');
            }
        }

        // Cerrar modal de motivaci√≥n
        function closeMotivationModal() {
            motivationModal.classList.remove('active');
            motivationInput.value = '';
            currentlyEditingIndex = -1;
            addMotivationBtn.textContent = 'Agregar';
        }

        // Agregar nueva frase
        function addMotivation() {
            const phrase = motivationInput.value.trim();
            if (!phrase) {
                alert('Please, write a motivational phrase.');
                return;
            }
            
            if (phrase.length > 200) {
                alert('The phrase is too long. Maximum 200 characters.');
                return;
            }
            
            if (currentlyEditingIndex >= 0) {
                // Editando frase existente
                motivationalPhrases[currentlyEditingIndex] = phrase;
                currentlyEditingIndex = -1;
                addMotivationBtn.textContent = 'Add';
            } else {
                // Agregando nueva frase
                motivationalPhrases.push(phrase);
            }
            
            saveMotivationalPhrases();
            renderMotivationList();
            motivationInput.value = '';
        }

        // Editar frase existente
        function editMotivation(index) {
            motivationInput.value = motivationalPhrases[index];
            currentlyEditingIndex = index;
            addMotivationBtn.textContent = 'Update';
            motivationInput.focus();
        }

        // Eliminar frase
        function deleteMotivation(index) {
            if (confirm('Are you sure you want to delete this phrase?')) {
                motivationalPhrases.splice(index, 1);
                saveMotivationalPhrases();
                renderMotivationList();
                
                // Si est√°bamos editando esta frase, cancelar edici√≥n
                if (currentlyEditingIndex === index) {
                    motivationInput.value = '';
                    currentlyEditingIndex = -1;
                    addMotivationBtn.textContent = 'Add';
                } else if (currentlyEditingIndex > index) {
                    currentlyEditingIndex--;
                }
            }
        }

        // Insertar frase aleatoria
        function insertRandomMotivation() {
            if (motivationalPhrases.length === 0) {
                alert('No motivational phrases available. Add some first.');
                return;
            }
            
            const randomPhrase = motivationalPhrases[Math.floor(Math.random() * motivationalPhrases.length)];
            insertMotivationToEditor(randomPhrase);
        }

        // Event Listeners para frases motivacionales
        if (motivationBtn) motivationBtn.addEventListener('click', openMotivationModal);
        if (motivationModalCancel) motivationModalCancel.addEventListener('click', closeMotivationModal);
        if (addMotivationBtn) addMotivationBtn.addEventListener('click', addMotivation);
        if (insertRandomBtn) insertRandomBtn.addEventListener('click', insertRandomMotivation);

        // Permitir agregar frase con Enter en textarea
        if (motivationInput) {
            motivationInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addMotivation();
                }
            });
        }

        // Cerrar modal al hacer clic fuera
        if (motivationModal) {
            motivationModal.addEventListener('click', (e) => {
                if (e.target === motivationModal) {
                    closeMotivationModal();
                }
            });
        }

        // Expandir el listener de mensajes existente para manejar datos de h√©roes
        window.addEventListener('message', (event) => {
            // ... el c√≥digo de mensajes existente se mantiene ...
            
            // Manejar datos de h√©roes para frases motivacionales
            if (event.data && event.data.type === 'heroesDataForMotivation') {
                heroesData = event.data.heroes;
                console.log('Datos de h√©roes recibidos para frases motivacionales:', heroesData?.length || 0, 'h√©roes');
            }
        });

        // Reconfigurar ciclos de im√°genes al cargar contenido guardado
        function reconfigureExistingMotivationEntries() {
            setTimeout(() => {
                const existingEntries = document.querySelectorAll('.motivation-entry[data-entry-id]');
                existingEntries.forEach(entry => {
                    const img = entry.querySelector('.motivation-hero-avatar');
                    if (img && !img.availableImages) {
                        // Crear un h√©roe b√°sico basado en la imagen actual
                        const heroData = {
                            name: img.dataset.heroName || 'Hero',
                            avatar: img.src,
                            secondImg: null,
                            ability1Img: null,
                            ability2Img: null
                        };
                        
                        setupHeroImageCycle(entry.dataset.entryId, heroData);
                    }
                });
            }, 500);
        }

        // Reconfigurar entradas "Today I Learned" existentes para agregar botones de eliminaci√≥n
        function reconfigureExistingLearnedTodayEntries() {
            setTimeout(() => {
                const existingEntries = document.querySelectorAll('.learned-today:not([data-entry-id])');
                existingEntries.forEach(entry => {
                    // Crear un ID √∫nico para esta entrada existente
                    const entryId = 'learned_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    entry.setAttribute('data-entry-id', entryId);
                    
                    // Verificar si ya tiene bot√≥n de eliminaci√≥n
                    if (!entry.querySelector('.learned-today-delete')) {
                        // Agregar bot√≥n de eliminaci√≥n
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'learned-today-delete';
                        deleteBtn.innerHTML = 'üóëÔ∏è';
                        deleteBtn.title = 'Delete';
                        deleteBtn.onclick = () => removeLearnedTodayEntry(entryId);
                        entry.appendChild(deleteBtn);
                    }
                });
            }, 500);
        }

        // Inicializar sistema de frases motivacionales
        loadMotivationalPhrases();
        
        // Reconfigurar entradas existentes cuando el contenido se cargue
        document.addEventListener('DOMContentLoaded', () => {
            reconfigureExistingMotivationEntries();
            reconfigureExistingLearnedTodayEntries();
        });
        
        // Tambi√©n reconfigurar cuando cambiemos de d√≠a
        const originalUpdateDiaryView = updateDiaryView;
        if (typeof updateDiaryView === 'function') {
            updateDiaryView = function() {
                originalUpdateDiaryView.apply(this, arguments);
                reconfigureExistingMotivationEntries();
                reconfigureExistingLearnedTodayEntries();
            };
        }

        // ========================================
        // SISTEMA DE CALENDARIO
        // ========================================

        const calendarModal = document.getElementById('calendarModal');
        const calendarBtn = document.getElementById('calendarBtn');
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarMonthYear = document.getElementById('calendarMonthYear');
        const calendarPrevMonth = document.getElementById('calendarPrevMonth');
        const calendarNextMonth = document.getElementById('calendarNextMonth');
        const calendarModalCancel = document.getElementById('calendarModalCancel');

        let calendarCurrentMonth = 9; // Octubre (0-based)
        let calendarCurrentYear = 2025;
        const minDate = new Date(2025, 9, 1); // 1 de octubre de 2025

        // Abrir modal de calendario
        function openCalendarModal() {
            calendarCurrentMonth = currentDate.getMonth();
            calendarCurrentYear = currentDate.getFullYear();
            renderCalendar();
            calendarModal.classList.add('active');
        }

        // Cerrar modal de calendario
        function closeCalendarModal() {
            calendarModal.classList.remove('active');
        }

        // Renderizar calendario
        function renderCalendar() {
            const firstDay = new Date(calendarCurrentYear, calendarCurrentMonth, 1);
            const lastDay = new Date(calendarCurrentYear, calendarCurrentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            const realToday = new Date();
            realToday.setHours(0, 0, 0, 0);

            // Actualizar t√≠tulo mes/a√±o
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            calendarMonthYear.textContent = `${monthNames[calendarCurrentMonth]} ${calendarCurrentYear}`;

            // Limpiar grid
            calendarGrid.innerHTML = '';

            // Headers de d√≠as de la semana
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            // Espacios vac√≠os antes del primer d√≠a
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day disabled';
                calendarGrid.appendChild(emptyDay);
            }

            // D√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;

                const cellDate = new Date(calendarCurrentYear, calendarCurrentMonth, day);
                
                // Verificar si la fecha est√° deshabilitada (antes del 1 de octubre O despu√©s del d√≠a actual)
                if (cellDate < minDate || cellDate > realToday) {
                    dayElement.classList.add('disabled');
                } else {
                    // Marcar d√≠a actual
                    if (cellDate.getTime() === currentDate.getTime()) {
                        dayElement.classList.add('current');
                    }

                    // Marcar d√≠a de hoy
                    if (cellDate.getTime() === realToday.getTime()) {
                        dayElement.classList.add('today');
                    }

                    // Agregar evento de clic
                    dayElement.addEventListener('click', () => {
                        goToDate(cellDate);
                    });
                }

                calendarGrid.appendChild(dayElement);
            }

            // Verificar si los botones de navegaci√≥n deben estar deshabilitados
            const prevMonth = new Date(calendarCurrentYear, calendarCurrentMonth - 1, 1);
            calendarPrevMonth.disabled = prevMonth < minDate;

            const nextMonth = new Date(calendarCurrentYear, calendarCurrentMonth + 1, 1);
            const realTodayMonth = new Date(realToday.getFullYear(), realToday.getMonth(), 1);
            calendarNextMonth.disabled = nextMonth > realTodayMonth;
        }

        // Ir a una fecha espec√≠fica
        function goToDate(date) {
            saveContent(); // Guardar contenido actual
            currentDate = new Date(date);
            updateDiaryView();
            closeCalendarModal();
        }

        // Navegar a mes anterior
        function goToPreviousMonth() {
            calendarCurrentMonth--;
            if (calendarCurrentMonth < 0) {
                calendarCurrentMonth = 11;
                calendarCurrentYear--;
            }
            renderCalendar();
        }

        // Navegar a mes siguiente
        function goToNextMonth() {
            calendarCurrentMonth++;
            if (calendarCurrentMonth > 11) {
                calendarCurrentMonth = 0;
                calendarCurrentYear++;
            }
            renderCalendar();
        }

        // Event Listeners para el calendario
        if (calendarBtn) calendarBtn.addEventListener('click', openCalendarModal);
        if (calendarModalCancel) calendarModalCancel.addEventListener('click', closeCalendarModal);
        if (calendarPrevMonth) calendarPrevMonth.addEventListener('click', goToPreviousMonth);
        if (calendarNextMonth) calendarNextMonth.addEventListener('click', goToNextMonth);

        // Cerrar modal al hacer clic fuera
        if (calendarModal) {
            calendarModal.addEventListener('click', (e) => {
                if (e.target === calendarModal) {
                    closeCalendarModal();
                }
            });
        }

        // ========================================
        // FIN SISTEMA DE CALENDARIO
        // ========================================

        // ========================================
        // FIN SISTEMA DE FRASES MOTIVACIONALES
        // ========================================
    </script>
</body>
</html>
