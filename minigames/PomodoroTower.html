<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self' data: https:;">
  <title>Pomodoro Tower</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #1a1a1a;
      color: white;
      font-family: "Segoe UI", sans-serif;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    .header-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      max-width: 900px;
    }

    header {
      font-size: 1.1rem;
      max-width: 700px;
      margin-bottom: 5px;
    }

    .timer-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-bottom: 10px;
    }

    .timer {
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 6px 14px;
      border-radius: 12px;
      white-space: nowrap;
    }

    .main-area {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin-top: 20px;
      gap: 120px;
      width: 100%;
      max-width: 800px;
    }

    .skill-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .skill-name {
      font-weight: bold;
      font-size: 1.1rem;
    }

    .skill-box {
      width: 200px;
      height: 200px;
      border-radius: 30px;
      background-color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: #aaa;
      text-align: center;
      padding: 10px;
    }

    .skill-lvl {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .timer-circle {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: #4CAF50;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      text-align: center;
      margin-top: 40px;
      transition: background 1s ease;
    }


    .reset-warning {
      margin-top: 40px;
      font-size: 1.3rem;
      font-weight: bold;
      text-align: center;
    }

    .reset-recommendation {
      margin-top: 8px;
      font-size: 1rem;
      text-align: center;
    }

    @media (max-width: 700px) {
      .main-area {
        flex-direction: column;
        align-items: center;
        gap: 30px;
      }

      .header-group {
        text-align: center;
        align-items: center;
      }
    }

    /* Heroes Circles Styles */
    .skill-with-heroes {
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
    }

    .hero-circles {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hero-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.4);
      overflow: hidden;
      transition: transform 0.2s, border-color 0.2s;
      cursor: pointer;
      position: relative;
    }

    .hero-circle:hover {
      transform: scale(1.1);
      border-color: rgba(255,255,255,0.8);
    }

    .hero-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Custom Tooltip */
    .hero-tooltip {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.2);
      min-width: 200px;
    }

    .hero-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #2c3e50;
    }

    .hero-circle:hover .hero-tooltip {
      opacity: 1;
    }

    .tooltip-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .tooltip-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
    }

    .tooltip-name {
      font-weight: bold;
      font-size: 0.9rem;
    }

    .tooltip-level {
      background: rgba(52, 152, 219, 0.8);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: auto;
    }

    .tooltip-exp {
      font-size: 0.75rem;
      color: #bdc3c7;
      margin-bottom: 8px;
    }

    .tooltip-abilities {
      display: flex;
      gap: 8px;
    }

    .ability-icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    @media (max-width: 700px) {
      .skill-with-heroes {
        flex-direction: column;
        gap: 10px;
      }
      
      .hero-circles {
        flex-direction: row;
        gap: 10px;
      }
      
      .hero-circle {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">

    <div class="header-group">
      <header>
        ‚ÄúTrue power is built through focus. In the Pomodoro Tower, your time becomes your weapon, and your effort‚Ä¶ your evolution.‚Äù
      </header>
      <div class="timer-group">
        <div id="dailyCount">DailyPomodoros: 0</div>
        <div class="timer" id="totalTimer">00:00 / <span id="targetTime">25:00</span></div>
      </div>
    </div>


    <div class="main-area">
      <div class="timer-circle" id="circle">
        <div id="stepLabel">Focus</div>
      </div>

      <div class="skill-container">
        <div class="skill-name" id="skillName">SkillName</div>
        <div class="skill-with-heroes">
          <div class="skill-box" id="skillBox">Skill Training üõ†Ô∏è</div>
          <div class="hero-circles" id="heroCircles"></div>
        </div>
        <div class="skill-lvl" id="skillLvl">Lvl: 1</div>
      </div>
    </div>

    <div class="reset-warning">IF YOU PLAY IN THE APP THE POMODORO‚ÄôS TIMER WILL RESET!</div>
    <div class="reset-recommendation">Recommendation: Minimize the app or keep it on the same view.</div>
  </div>

  <script type="module">
    // Heroes display functions
    function createHeroCircle(hero) {
      const circle = document.createElement('div');
      circle.className = 'hero-circle';
      
      const avatar = document.createElement('img');
      avatar.src = hero.avatar || '../src/Population/DefaultAvatar.png';
      avatar.onerror = () => avatar.src = '../src/Population/DefaultAvatar.png';
      
      // Crear tooltip por defecto con formato: [Nombre] Lvl: X [ability1] [ability2]
      let tooltipText = `${hero.name} Lvl: ${hero.level}`;
      
      // Agregar abilities solo si no est√°n vac√≠as
      const abilities = [];
      if (hero.ability1 && hero.ability1.trim() !== "") {
        abilities.push(hero.ability1);
      }
      if (hero.ability2 && hero.ability2.trim() !== "") {
        abilities.push(hero.ability2);
      }
      
      if (abilities.length > 0) {
        tooltipText += ' [' + abilities.join('] [') + ']';
      }
      
      circle.title = tooltipText;
      
      // Configurar ciclo de im√°genes
      const availableImages = [];
      
      // Imagen principal (avatar)
      if (hero.avatar) {
        availableImages.push({ src: hero.avatar, name: 'Avatar' });
      } else {
        availableImages.push({ src: '../src/Population/DefaultAvatar.png', name: 'Avatar' });
      }
      
      // Segunda imagen
      if (hero.secondImg) {
        availableImages.push({ src: hero.secondImg, name: '2nd Image' });
      }
      
      // Ability 1 imagen
      if (hero.ability1Img) {
        availableImages.push({ src: hero.ability1Img, name: 'Ability 1' });
      }
      
      // Ability 2 imagen
      if (hero.ability2Img) {
        availableImages.push({ src: hero.ability2Img, name: 'Ability 2' });
      }
      
      // Configurar √≠ndice actual y evento de clic
      circle.currentImageIndex = 0;
      circle.availableImages = availableImages;
      
      circle.addEventListener('click', function() {
        if (this.availableImages.length > 1) {
          this.currentImageIndex = (this.currentImageIndex + 1) % this.availableImages.length;
          const newImage = this.availableImages[this.currentImageIndex];
          avatar.src = newImage.src;
          avatar.onerror = () => avatar.src = '../src/Population/DefaultAvatar.png';
          console.log(`Cambiando a: ${newImage.name}`);
        }
      });
      
      circle.appendChild(avatar);
      
      return circle;
    }

    function displayHeroes(heroes) {
      const heroCircles = document.getElementById('heroCircles');
      
      if (!heroes || heroes.length === 0) {
        heroCircles.style.display = 'none';
        return;
      }
      
      heroCircles.innerHTML = '';
      heroes.forEach(hero => {
        const heroCircle = createHeroCircle(hero);
        heroCircles.appendChild(heroCircle);
      });
      
      heroCircles.style.display = 'flex';
    }

    // Listen for heroes data from parent
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'heroesData') {
        displayHeroes(event.data.heroes);
      }
    });

    const params = new URLSearchParams(location.search);
    let sName = params.get('name');
    let sLvl = params.get('level');
    let sImg = params.get('img');
    const key = params.get('key');
    if (key) {
      try {
        const data = JSON.parse(sessionStorage.getItem('pomodoroTowerData-' + key));
        if (data) {
          if (!sName) sName = data.name;
          if (!sLvl) sLvl = data.level;
          if (!sImg) sImg = data.img;
        }
      } catch {}
    }
    if (sName) document.getElementById('skillName').textContent = sName;
    if (sLvl) document.getElementById('skillLvl').textContent = 'Lvl: ' + sLvl;
    if (sImg) {
      const el = document.getElementById('skillBox');
      el.style.backgroundImage = `url(${sImg})`;
      el.style.backgroundSize = 'cover';
      el.textContent = '';
    }

    const circle = document.getElementById("circle");
    const stepLabel = document.getElementById("stepLabel");
    const totalTimer = document.getElementById("totalTimer");
    const dailyCount = document.getElementById("dailyCount");

    const minutes = parseInt(params.get('minutes') || '25');
    const totalDuration = minutes * 60;
    document.getElementById('targetTime').textContent = formatTime(totalDuration);
    let totalSeconds = 0;
    let sessionCompleted = false;
    const startTime = Date.now();
    const dailyKey = 'pomodoroTowerDaily';
    let dailyData;
    try {
      dailyData = JSON.parse(localStorage.getItem(dailyKey) || '{}');
    } catch {
      dailyData = {};
    }
    const todayStr = new Date().toDateString();
    if (dailyData.date !== todayStr) {
      dailyData = { date: todayStr, count: 0 };
      localStorage.setItem(dailyKey, JSON.stringify(dailyData));
    }
    let dailyPomodoros = dailyData.count || 0;
    dailyCount.textContent = `DailyPomodoros: ${dailyPomodoros}`;

    function formatTime(sec) {
      const m = String(Math.floor(sec / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    let timerId;
    function updatePomodoroTimer() {
      totalSeconds = Math.floor((Date.now() - startTime) / 1000);
      totalTimer.textContent = `${formatTime(totalSeconds)} / ${formatTime(totalDuration)}`;
      if (totalSeconds >= totalDuration && !sessionCompleted) {
        sessionCompleted = true;
        clearInterval(timerId);
        dailyPomodoros++;
        dailyData.count = dailyPomodoros;
        localStorage.setItem(dailyKey, JSON.stringify(dailyData));
        dailyCount.textContent = `DailyPomodoros: ${dailyPomodoros}`;
        stepLabel.textContent = "Session Complete";
        circle.style.background = "#666";
        parent.postMessage({type:'pomodoroTowerComplete', elapsedSec: totalSeconds}, '*');
      }
    }

    timerId = setInterval(updatePomodoroTimer, 1000); // Mantener 1 segundo para funcionalidad del minijuego
    updatePomodoroTimer();
  </script>
</body>
</html>
