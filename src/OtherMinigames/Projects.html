<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projects (PAbilities ⬆️)</title>
  <style>
    :root{
      --bg:#0e0f12;
      --panel:#121420;
      --panel2:#0f1320;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --gold1:#ffe9a3;
      --gold2:#e9c979;
      --ok:#34d399;
      --danger:#ef4444;
      --accent:#7dd3fc;
      --border: rgba(255,255,255,.12);
      --warn:#fca5a5;
    }
    *{ box-sizing:border-box; user-select:none; -webkit-user-select:none; -ms-user-select:none; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 600px at 30% 10%, #131729, #0b0d13 60%);
      color:var(--text);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{
      width:min(820px, 92vw); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:18px;
      box-shadow: 0 18px 40px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .row{ display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap }
    h1{ font-size:22px; margin:0; display:flex; align-items:baseline; gap:6px }
    h1 small{ font-size:14px; color:var(--muted); font-weight:normal; display:flex; align-items:center; gap:8px }
    .badge{
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
      padding:8px 12px; border-radius:12px; font-weight:700; cursor:default;
    }
    .points{ cursor:default; }
    .gold{ color:#000; background: linear-gradient(180deg, var(--gold1), var(--gold2)); border:0; box-shadow: inset 0 1px 0 rgba(255,255,255,.6);}
    .tab, .chip, button{ padding:8px 12px; border-radius:12px; border:1px solid var(--border); background: rgba(255,255,255,.04); cursor:pointer; font-weight:700; line-height:1; }
    .tab.active{ outline:2px solid rgba(125,211,252,.6); background: rgba(125,211,252,.08) }
    button{ background: var(--panel2); color: var(--text); }
    button.danger{ border-color: rgba(239,68,68,.45) }

    /* Views */
    .views{ margin-top:16px; }
    .hidden{ display:none !important }
    .stack{ display:grid; gap:10px }

    .card{
      position: relative;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px 12px 12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .card h3{ margin:0 0 4px 0; font-size:16px; color:#fff }
    .card p{ margin:0; color:var(--muted); font-size:13px }

    .card-actions{
      position:absolute;
      top:8px;
      right:8px;
      display:flex;
      gap:6px;
      align-items:center;
    }

    /* Overlays / Modals */
    .overlay{
      position: fixed; inset:0; display:none; place-items:center;
      background: rgba(0,0,0,.6);
      z-index: 30;
    }
    .overlay.show{ display:grid }
    .modal{
      width:min(520px, 92vw);
      background: var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .modal h2{ margin:0 0 8px 0; font-size:18px; color:#fff }
    .field{ display:grid; gap:6px; margin:10px 0 }
    .field label{ font-size:13px; color:var(--muted) }
    .field input, .field textarea, .field select{
      width:100%; background: var(--panel2); color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:10px; font-size:14px; outline:none;
      user-select:text; -webkit-user-select:text;
    }
    .field input[type="number"]{ appearance:textfield; -moz-appearance:textfield; }
    .field input::-webkit-outer-spin-button, .field input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    .error{ color: var(--warn); font-size:12px; min-height:16px; }
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .btn-primary{ background: rgba(125,211,252,.1); border-color: rgba(125,211,252,.5) }
    .btn-danger{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.5) }

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOutLeft {
      to { opacity: 0; transform: translateX(-12px); }
    }
    .fade-in { animation: fadeInUp 260ms ease-out; }
    .leaving { animation: fadeOutLeft 220ms ease-in forwards; }
  </style>
</head>
<body>
  <div class="app">
    <div class="row">
      <h1>
        Projects
        <small>
          <button class="tab" id="btnStartProject">Start Project</button>
          <div class="tab active" id="tabActive">Active Projects</div>
          <div class="tab" id="tabFinished">Finished Projects</div>
          <span class="badge gold points" id="pointsBadge">Points: 0</span>
          <button class="tab" id="btnPAbility">PAbilities ⬆️</button>
          <button id="btnReset" class="danger">Reset</button>
        </small>
      </h1>
    </div>

    <div class="views">
      <div id="viewActive" class="stack"></div>
      <div id="viewFinished" class="stack hidden"></div>
    </div>
  </div>

  <!-- Modal: Start Project -->
  <div class="overlay" id="overlayStart">
    <div class="modal">
      <h2>Start a new project</h2>
      <div class="field">
        <label for="inpName">Project name</label>
        <input id="inpName" placeholder="e.g., Read 'Atomic Habits'"/>
      </div>
      <div class="field">
        <label for="inpDesc">Description (optional)</label>
        <textarea id="inpDesc" placeholder="What is this project about?"></textarea>
      </div>
      <div id="errMsg" class="error"></div>
      <div class="actions">
        <button id="btnCancelStart">Cancel</button>
        <button id="btnConfirmStart" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Modal: Edit Project -->
  <div class="overlay" id="overlayEdit">
    <div class="modal">
      <h2>Edit project</h2>
      <div class="field">
        <label for="inpEditName">Project name</label>
        <input id="inpEditName"/>
      </div>
      <div class="field">
        <label for="inpEditDesc">Description (optional)</label>
        <textarea id="inpEditDesc"></textarea>
      </div>
      <div id="errEdit" class="error"></div>
      <div class="actions">
        <button id="btnCancelEdit">Cancel</button>
        <button id="btnConfirmEdit" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Modal: Confirm Reset -->
  <div class="overlay" id="overlayReset">
    <div class="modal">
      <h2>Reset data</h2>
      <p style="color:var(--muted); margin:8px 0 0">This will clear Points and all Projects.</p>
      <div class="actions">
        <button id="btnCancelReset">Cancel</button>
        <button id="btnConfirmReset" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Modal: Add Minutes -->
  <div class="overlay" id="overlayMinutes">
    <div class="modal">
      <h2>Add minutes</h2>
      <div class="field">
        <label for="inpMinutes">Minutes to add</label>
        <input id="inpMinutes" type="number" min="1" step="1" placeholder="e.g., 30"/>
      </div>
      <div id="errMin" class="error"></div>
      <div class="actions">
        <button id="btnCancelMinutes">Cancel</button>
        <button id="btnConfirmMinutes" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Modal: Delete Finished Project -->
  <div class="overlay" id="overlayDelete">
    <div class="modal">
      <h2>Delete project</h2>
      <p style="color:var(--muted); margin:8px 0 0">This will permanently remove the project from Finished Projects.</p>
      <div class="actions">
        <button id="btnCancelDelete">Cancel</button>
        <button id="btnConfirmDelete" class="btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- Modal: Select Ability on Finish -->
  <div class="overlay" id="overlayAbility">
    <div class="modal">
      <h2>Select Partner Ability</h2>
      <p style="color:var(--muted); margin:4px 0 12px;">Choose which ability to reward for this finished project.</p>
      <div class="field">
        <label for="pbSelect">PAbility</label>
        <select id="pbSelect"></select>
      </div>
      <div class="actions">
        <button id="btnCancelAbility">Cancel</button>
        <button id="btnConfirmAbility" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Modal: Spend Points on PAbility -->
  <div class="overlay" id="overlaySpend">
    <div class="modal">
      <h2>Spend 30 Points</h2>
      <p style="color:var(--muted); margin:4px 0 12px;">Choose a Partner Ability to invest 30 points.</p>
      <div class="field">
        <label for="pbSpendSelect">PAbility</label>
        <select id="pbSpendSelect"></select>
      </div>
      <div id="errSpend" class="error"></div>
      <div class="actions">
        <button id="btnCancelSpend">Cancel</button>
        <button id="btnConfirmSpend" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    const KEY = {
      points: "syw_points",
      projects: "syw_projects_v1",
      abilities: "syw_partner_abilities_v1"
    };

    /** @type {{id:string,name:string,desc:string,status:'active'|'finished',createdAt:number, minutes:number, rewardAbility?:string}[]} */
    let projects = [];

    // Modal state
    let minutesTargetId = null;
    let deleteTargetId = null;
    let pendingFinishId = null;
    let editTargetId = null;

    // DOM
    const overlayStart = document.getElementById('overlayStart');
    const overlayReset = document.getElementById('overlayReset');
    const overlayMinutes = document.getElementById('overlayMinutes');
    const overlayDelete = document.getElementById('overlayDelete');
    const overlayAbility = document.getElementById('overlayAbility');
    const overlaySpend = document.getElementById('overlaySpend');
    const overlayEdit = document.getElementById('overlayEdit');

    const inpName = document.getElementById('inpName');
    const inpDesc = document.getElementById('inpDesc');
    const errMsg = document.getElementById('errMsg');

    const inpMinutes = document.getElementById('inpMinutes');
    const errMin = document.getElementById('errMin');

    const pbSelect = document.getElementById('pbSelect');
    const pbSpendSelect = document.getElementById('pbSpendSelect');
    const errSpend = document.getElementById('errSpend');
    const inpEditName = document.getElementById('inpEditName');
    const inpEditDesc = document.getElementById('inpEditDesc');
    const errEdit = document.getElementById('errEdit');

    const viewActive = document.getElementById('viewActive');
    const viewFinished = document.getElementById('viewFinished');
    const pointsBadge = document.getElementById('pointsBadge');
    const btnPAbility = document.getElementById('btnPAbility');
    const btnConfirmAbility = document.getElementById('btnConfirmAbility');
    const btnConfirmSpend = document.getElementById('btnConfirmSpend');

    function notifySave(){ window.parent?.scheduleSaveGame?.(); }
    function updateParent(){ window.parent?.renderVillageChief?.(); }

    // Preferir datos recibidos por postMessage en producción; fallback al parent (desarrollo)
    let externalPartner = null;
    function getUnlockedAbilities(){
      const srcAbilities = externalPartner?.abilities || window.parent?.villageChief?.partnerAbilities || [];
      const unlockedCount = externalPartner?.unlockedPartnerAbilities ?? window.parent?.villageChief?.unlockedPartnerAbilities ?? srcAbilities.length;
      return srcAbilities.filter((ab, idx) => (ab.number ?? idx + 1) <= unlockedCount);
    }

    function populateAbilitySelect(sel, confirmBtn){
      const abilities = getUnlockedAbilities();
      const prev = sel.value;
      sel.innerHTML = '';
      if(abilities.length === 0){
        const opt = document.createElement('option');
        opt.textContent = 'No unlocked abilities available';
        sel.appendChild(opt);
        sel.disabled = true;
        if(confirmBtn) confirmBtn.disabled = true;
      } else {
        abilities.forEach(ab => {
          const opt = document.createElement('option');
          opt.value = ab.name;
          opt.textContent = `${ab.name} (Lvl: ${ab.level || 1})`;
          sel.appendChild(opt);
        });
        sel.disabled = false;
        if(confirmBtn){
          confirmBtn.disabled = false;
          if(prev && abilities.some(ab => ab.name === prev)) sel.value = prev;
        }
      }
    }

    function populateAllAbilitySelects(){
      populateAbilitySelect(pbSelect, btnConfirmAbility);
      populateAbilitySelect(pbSpendSelect, btnConfirmSpend);
    }

    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    function load(){
      try{ projects = JSON.parse(localStorage.getItem(KEY.projects)||"[]"); }
      catch{ projects = []; }
      projects.forEach(p => { if(typeof p.minutes !== 'number') p.minutes = 0; });
    }
    function save(){ localStorage.setItem(KEY.projects, JSON.stringify(projects)); }
    function setPoints(v){ localStorage.setItem(KEY.points, String(v)); }
    function getPoints(){ return Number(localStorage.getItem(KEY.points)||"0"); }
    function fmtDate(ts){ const d = new Date(ts); return d.toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'}); }

    function render(){
      pointsBadge.textContent = "Points: " + getPoints();

      // active projects
      viewActive.innerHTML = "";
      const active = projects.filter(p=>p.status==='active');
      if(active.length===0){
        const empty = document.createElement('div');
        empty.style.color = 'var(--muted)';
        empty.textContent = "No active projects yet. Start one!";
        viewActive.appendChild(empty);
      }else{
        active.forEach(p=>{
          const card = document.createElement('div');
          card.className = 'card fade-in';
          card.innerHTML = `
            <div>
              <h3>${p.name}</h3>
              <p>${p.desc ? p.desc : ''}</p>
              <p style="margin-top:6px; font-size:12px; color:#cbd5e1">Started: ${fmtDate(p.createdAt)}</p>
              <p style="margin-top:4px; font-size:13px; color:#e5e7eb">Minutes Spent on the project: <strong>${p.minutes}</strong></p>
            </div>
            <div class="card-actions">
              <button class="chip" data-act="edit" data-id="${p.id}">EditProject</button>
              <button class="chip" data-act="addmin" data-id="${p.id}">AddMinutes</button>
              <button class="chip" data-act="finish" data-id="${p.id}">FinishProject</button>
            </div>
          `;
          viewActive.appendChild(card);
        });
      }

      // finished
      viewFinished.innerHTML = "";
      const fin = projects.filter(p=>p.status==='finished');
      fin.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'card fade-in';
        card.innerHTML = `
          <div>
            <h3>${p.name}</h3>
            <p>${p.desc || ''}</p>
            <p style="margin-top:6px; font-size:12px; color:#cbd5e1">Started: ${fmtDate(p.createdAt)}</p>
            <p style="margin-top:4px; font-size:13px; color:#e5e7eb">Minutes Spent on the project: <strong>${p.minutes}</strong></p>
            ${p.rewardAbility ? `<p style="margin-top:4px; font-size:12px; color:#cbd5e1">Rewarded: ${p.rewardAbility}</p>` : ''}
          </div>
          <div class="card-actions">
            <button class="chip" data-act="edit" data-id="${p.id}">EditProject</button>
            <button class="chip" title="Reactivate Project" data-act="reactivate" data-id="${p.id}">🔄</button>
            <button class="chip btn-danger" title="Delete Project" data-act="delete" data-id="${p.id}">🗑️</button>
          </div>
        `;
        viewFinished.appendChild(card);
      });
    }

    // Modal open/close helpers
    function open(el){ el.classList.add('show'); }
    function close(el){ el.classList.remove('show'); }

    function openStart(){ open(overlayStart); errMsg.textContent = ""; inpName.value = ""; inpDesc.value = ""; setTimeout(()=>inpName.focus(),0); }
    function closeStart(){ close(overlayStart); }

    function openReset(){ open(overlayReset); }
    function closeReset(){ close(overlayReset); }

    function openMinutes(id){ minutesTargetId = id; open(overlayMinutes); errMin.textContent=""; inpMinutes.value=""; setTimeout(()=>inpMinutes.focus(),0); }
    function closeMinutes(){ close(overlayMinutes); minutesTargetId=null; }

    function openDelete(id){ deleteTargetId = id; open(overlayDelete); }
    function closeDelete(){ close(overlayDelete); deleteTargetId=null; }

    function openAbility(id){
      pendingFinishId = id;
      populateAbilitySelect(pbSelect, btnConfirmAbility);
      open(overlayAbility);
    }
    function closeAbility(){ close(overlayAbility); pendingFinishId=null; }

    function openSpend(){
      populateAbilitySelect(pbSpendSelect, btnConfirmSpend);
      open(overlaySpend);
      errSpend.textContent="";
    }
    function closeSpend(){ close(overlaySpend); }

    function openEdit(id){
      editTargetId = id;
      const p = projects.find(pr=>pr.id===id);
      if(p){
        inpEditName.value = p.name;
        inpEditDesc.value = p.desc || '';
      }
      errEdit.textContent='';
      open(overlayEdit);
      setTimeout(()=>inpEditName.focus(),0);
    }
    function closeEdit(){ close(overlayEdit); editTargetId=null; }

    // Header / global button events
    document.getElementById("btnReset").addEventListener("click", openReset);
    document.getElementById('btnStartProject').addEventListener('click', openStart);
    btnPAbility.addEventListener('click', openSpend);

    // Start project modal
    document.getElementById('btnCancelStart').addEventListener('click', closeStart);
    document.getElementById('btnConfirmStart').addEventListener('click', () => {
      const name = inpName.value.trim();
      const desc = inpDesc.value.trim();
      if(!name){ errMsg.textContent = "Please enter a project name."; inpName.focus(); return; }
      const p = { id: uid(), name, desc, status:'active', createdAt: Date.now(), minutes: 0 };
      projects.push(p);
      save();
      notifySave();
      closeStart();
      render();
    });
    [inpName, inpDesc].forEach(el => el.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('btnConfirmStart').click(); }
    }));

    // Reset modal
    document.getElementById("btnCancelReset").addEventListener("click", closeReset);
    document.getElementById("btnConfirmReset").addEventListener("click", () => {
      localStorage.removeItem(KEY.points);
      localStorage.removeItem(KEY.projects);
      setPoints(0);
      projects = [];
      save();
      notifySave();
      closeReset();
      render();
    });

    // Minutes modal
    document.getElementById('btnCancelMinutes').addEventListener('click', closeMinutes);
    document.getElementById('btnConfirmMinutes').addEventListener('click', () => {
      const raw = inpMinutes.value.trim();
      const n = Number(raw);
      if(!raw || !Number.isFinite(n) || n <= 0){
        errMin.textContent = "Please enter a valid number of minutes (> 0).";
        inpMinutes.focus();
        return;
      }
      const idx = projects.findIndex(p=>p.id===minutesTargetId);
      if(idx>=0){
        const inc = Math.floor(n);
        projects[idx].minutes = (projects[idx].minutes||0) + inc;
        setPoints(getPoints() + inc); // 1 point per minute
        save();
        notifySave();
      }
      closeMinutes();
      render();
    });
    document.getElementById('inpMinutes').addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('btnConfirmMinutes').click(); }
    });

    // Delete modal
    document.getElementById('btnCancelDelete').addEventListener('click', closeDelete);
    document.getElementById('btnConfirmDelete').addEventListener('click', ()=>{
      if(deleteTargetId){ projects = projects.filter(p=>p.id !== deleteTargetId); save(); notifySave(); }
      closeDelete();
      render();
    });

    // Ability on Finish modal
    document.getElementById('btnCancelAbility').addEventListener('click', closeAbility);
    btnConfirmAbility.addEventListener('click', ()=>{
      if(!pendingFinishId){ closeAbility(); return; }
      const idx = projects.findIndex(p=>p.id===pendingFinishId);
      if(idx>=0){
        const chosen = pbSelect.value;
        projects[idx].rewardAbility = chosen;
        projects[idx].status = 'finished';
        setPoints(getPoints() + 100);
        // Notificar al padre para actualizar el nivel
        try{
          window.parent?.postMessage?.({ type: 'projectsLevelUp', abilityName: chosen, delta: 5 }, '*');
        }catch{}
        save();
        notifySave();
      }
      closeAbility();
      render();
    });

    // Spend Points modal
    document.getElementById('btnCancelSpend').addEventListener('click', closeSpend);
    btnConfirmSpend.addEventListener('click', ()=>{
      const pts = getPoints();
      if(pts < 30){ errSpend.textContent = "Not enough points. You need 30 Points."; return; }
      const chosen = pbSpendSelect.value;
      // Notificar al padre para actualizar el nivel
      try{
        window.parent?.postMessage?.({ type: 'projectsLevelUp', abilityName: chosen, delta: 1 }, '*');
      }catch{}
      setPoints(pts - 30);
      notifySave();
      closeSpend();
      render();
    });

    // Card action delegation (Active / Finished lists)
    function handleAction(e){
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      if(act==='addmin'){ openMinutes(id); }
      else if(act==='finish'){ openAbility(id); }
      else if(act==='edit'){ openEdit(id); }
      else if(act==='reactivate'){
        const idx = projects.findIndex(p=>p.id===id);
        if(idx>=0){ projects[idx].status = 'active'; save(); notifySave(); render(); }
      }
      else if(act==='delete'){ openDelete(id); }
    }
    viewActive.addEventListener('click', handleAction);
    viewFinished.addEventListener('click', handleAction);

    // Tabs (Active by default)
    const tabActive = document.getElementById('tabActive');
    const tabFinished = document.getElementById('tabFinished');
    function setTab(which){
      if(which==='active'){
        tabActive.classList.add('active');
        tabFinished.classList.remove('active');
        viewActive.classList.remove('hidden');
        viewFinished.classList.add('hidden');
      }else{
        tabFinished.classList.add('active');
        tabActive.classList.remove('active');
        viewFinished.classList.remove('hidden');
        viewActive.classList.add('hidden');
      }
    }
    tabActive.addEventListener('click', ()=>setTab('active'));
    tabFinished.addEventListener('click', ()=>setTab('finished'));

    // Mensajes externos (producción)
    window.addEventListener('message', (e)=>{
      const d = e.data;
      if(!d) return;
      if(d.type === 'projectsData' && d.partner){
        externalPartner = d.partner;
        // Repoblar selects si modales abiertos
        try { populateAllAbilitySelects(); } catch {}
      }
    });

    // Init
    load();
    setPoints(getPoints() || 0);
    setTab('active'); // Default view
    render();
    populateAllAbilitySelects();

    // Edit modal
    document.getElementById('btnCancelEdit').addEventListener('click', closeEdit);
    document.getElementById('btnConfirmEdit').addEventListener('click', ()=>{
      if(!editTargetId){ closeEdit(); return; }
      const name = inpEditName.value.trim();
      const desc = inpEditDesc.value.trim();
      if(!name){ errEdit.textContent = "Please enter a project name."; inpEditName.focus(); return; }
      const idx = projects.findIndex(p=>p.id===editTargetId);
      if(idx>=0){ projects[idx].name = name; projects[idx].desc = desc; save(); notifySave(); }
      closeEdit();
      render();
    });
    [inpEditName, inpEditDesc].forEach(el=>el.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('btnConfirmEdit').click(); }}));
  </script>
</body>
</html>
